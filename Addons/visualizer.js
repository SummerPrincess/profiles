var AUDIO=AUDIO||{};AUDIO.VISUALIZER=(function(){var e=null;var d=512;var f={lounge:"renderLounge"};function a(g){this.isPlaying=false;this.autoplay=g.autoplay||false;this.loop=g.loop||false;this.audio=document.getElementById(g.audio)||{};this.canvas=document.getElementById(g.canvas)||{};this.canvasCtx=this.canvas.getContext("2d")||null;this.author=this.audio.getAttribute("data-author")||"";this.title=this.audio.getAttribute("data-title")||"";this.ctx=null;this.analyser=null;this.sourceNode=null;this.frequencyData=[];this.audioSrc=null;this.duration=0;this.minutes="00";this.seconds="00";this.style=g.style||"lounge";this.barWidth=g.barWidth||2;this.barHeight=g.barHeight||2;this.barSpacing=g.barSpacing||5;this.barColor=g.barColor||"#ffffff";this.shadowBlur=g.shadowBlur||10;this.shadowColor=g.shadowColor||"#ffffff";this.font=g.font||["12px","Helvetica"];this.gradient=null}a.prototype.setContext=function(){try{window.AudioContext=window.AudioContext||window.webkitAudioContext;this.ctx=new window.AudioContext();return this}catch(g){console.info("Web Audio API is not supported.",g)}};a.prototype.setAnalyser=function(){this.analyser=this.ctx.createAnalyser();this.analyser.smoothingTimeConstant=0.6;this.analyser.fftSize=d;return this};a.prototype.setFrequencyData=function(){this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount);return this};a.prototype.setBufferSourceNode=function(){this.sourceNode=this.ctx.createBufferSource();this.sourceNode.loop=this.loop;this.sourceNode.connect(this.analyser);this.sourceNode.connect(this.ctx.destination);this.sourceNode.onended=function(){clearInterval(e);this.sourceNode.disconnect();this.resetTimer();this.isPlaying=false;this.sourceNode=this.ctx.createBufferSource()}.bind(this);return this};a.prototype.setMediaSource=function(){this.audioSrc=this.audio.getAttribute("src");return this};a.prototype.setCanvasStyles=function(){this.gradient=this.canvasCtx.createLinearGradient(0,0,0,300);this.gradient.addColorStop(1,this.barColor);this.canvasCtx.fillStyle=this.gradient;this.canvasCtx.shadowBlur=this.shadowBlur;this.canvasCtx.shadowColor=this.shadowColor;this.canvasCtx.font=this.font.join(" ");this.canvasCtx.textAlign="center";return this};a.prototype.bindEvents=function(){var g=this;document.addEventListener("click",function(h){if(h.target===g.canvas){h.stopPropagation();if(!g.isPlaying){return(g.ctx.state==="suspended")?g.playSound():g.loadSound()}else{return g.pauseSound()}}});if(g.autoplay){g.loadSound()}return this};a.prototype.loadSound=function(){var g=new XMLHttpRequest();g.open("GET",this.audioSrc,true);g.responseType="arraybuffer";this.canvasCtx.fillText("Loading...",this.canvas.width/2+10,this.canvas.height/2);g.onload=function(){this.ctx.decodeAudioData(g.response,this.playSound.bind(this),this.onError.bind(this))}.bind(this);g.send()};a.prototype.playSound=function(g){this.isPlaying=true;if(this.ctx.state==="suspended"){return this.ctx.resume()}this.sourceNode.buffer=g;this.sourceNode.start(0);this.resetTimer();this.startTimer();this.renderFrame()};a.prototype.pauseSound=function(){this.ctx.suspend();this.isPlaying=false};a.prototype.startTimer=function(){var g=this;e=setInterval(function(){if(g.isPlaying){var h=new Date(g.duration);var i=h.getHours();var j=h.getMinutes();g.minutes=(i<10)?"0"+i:i;g.seconds=(j<10)?"0"+j:j;g.duration=h.setMinutes(j+1)}},1000)};a.prototype.resetTimer=function(){var g=new Date(0,0);this.duration=g.getTime()};a.prototype.onError=function(g){console.info("Error decoding audio file. -- ",g)};a.prototype.renderFrame=function(){requestAnimationFrame(this.renderFrame.bind(this));this.analyser.getByteFrequencyData(this.frequencyData);this.canvasCtx.clearRect(0,0,this.canvas.width,this.canvas.height);this.renderTime();this.renderText();this.renderByStyleType()};a.prototype.renderText=function(){var g=this.canvas.width/2;var i=this.canvas.height/2;var h=10;this.canvasCtx.textBaseline="top";this.canvasCtx.fillText("by "+this.author,g+h,i);this.canvasCtx.font=parseInt(this.font[0],10)+8+"px "+this.font[1];this.canvasCtx.textBaseline="bottom";this.canvasCtx.fillText(this.title,g+h,i);this.canvasCtx.font=this.font.join(" ")};a.prototype.renderTime=function(){var g=this.minutes+":"+this.seconds;this.canvasCtx.fillText(g,this.canvas.width/2+10,this.canvas.height/2+40)};a.prototype.renderByStyleType=function(){return this[f[this.style]]()};a.prototype.renderLounge=function(){var l=this.canvas.width/2;var k=this.canvas.height/2;var r=140;var m=Math.floor((r*2*Math.PI)/(this.barWidth+this.barSpacing));var t=Math.floor((m*25)/100);var o=m-t;var g=Math.floor(this.frequencyData.length/m);for(var n=0;n<o;n++){var j=this.frequencyData[n*g];var q=(n*2*Math.PI)/m;var z=(3*45-this.barWidth)*Math.PI/180;var u=0;var s=r-(j/12-this.barHeight);var v=this.barWidth;var p=j/6+this.barHeight;this.canvasCtx.save();this.canvasCtx.translate(l+this.barSpacing,k+this.barSpacing);this.canvasCtx.rotate(q-z);this.canvasCtx.fillRect(u,s,v,p);this.canvasCtx.restore()}};function c(g){var h=new a(g);return function(){h.setContext().setAnalyser().setFrequencyData().setBufferSourceNode().setMediaSource().setCanvasStyles().bindEvents();return h}}function b(g){return c(g)()}return{getInstance:b}})();document.addEventListener("DOMContentLoaded",function(){AUDIO.VISUALIZER.getInstance({autoplay:true,loop:true,audio:"moosic",canvas:"musicCanvas",style:"lounge",barWidth:2,barHeight:2,barSpacing:7,barColor:"#60c65d",shadowBlur:20,shadowColor:"#111111",font:["12px","Helvetica"]})},false);
